<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #f7f6f6;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>麻將日誌</title>
    <!-- 引入外部資源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [v-cloak] { display: none !important; }

        body {
            font-family: 'Noto Serif TC', serif;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #f7f6f6;
            color: #302b28;
            margin: 0;
        }

        .ios-pwa-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .active-scale:active { transform: scale(0.95); transition: transform 0.1s; }
        
        @media (min-width: 768px) {
            .active-scale:hover { transform: scale(1.01); transition: transform 0.2s; }
        }

        .category-chip {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 900;
            transition: all 0.2s;
            border-width: 1px;
            cursor: pointer;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-enter-active, .fade-leave-active { transition: opacity-0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body>
    <div id="app" class="ios-pwa-container overflow-x-hidden" v-cloak>
        <div class="h-[env(safe-area-inset-top)] w-full bg-[#f7f6f6] sticky top-0 z-50 no-export"></div>

        <!-- 主容器 -->
        <div ref="mainContent" class="w-full max-w-6xl mx-auto flex flex-col gap-4 px-3 sm:px-6 md:px-10 pb-32">
            
            <!-- Header 標題列 -->
            <div class="pt-6 sm:pt-8 pb-1 text-center relative">
                <!-- 左上角功能 -->
                <div class="absolute left-0 top-6 sm:top-8 flex items-center gap-0.5 sm:gap-1.5 no-export">
                    <button @click="handleManualRefresh" class="p-1.5 sm:p-2 text-[#999] active-scale" title="刷新">
                        <i data-lucide="rotate-cw" :class="{'animate-spin text-[#1893f8]': cloudStatus === 'syncing'}" class="w-5 h-5"></i>
                    </button>
                    <template v-if="activeTab === 'calendar'">
                        <button @click="downloadImage" class="p-1.5 sm:p-2 text-[#999] active-scale" title="截圖">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </button>
                        <button @click="isMonthDetailOpen = true" class="p-1.5 sm:p-2 text-[#999] active-scale" title="明細">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                        </button>
                    </template>
                </div>

                <div class="absolute right-0 top-6 sm:top-8 flex items-center no-export">
                    <button @click="handleQuickAdd" class="p-1.5 sm:p-2 text-[#999] active-scale">
                        <i data-lucide="plus" class="w-7 h-7"></i>
                    </button>
                </div>

                <h1 class="text-3xl sm:text-4xl font-black text-[#201f1f] tracking-widest mb-2">麻將日誌</h1>
                <div class="h-0.5 w-12 sm:w-16 bg-[#1893f8]/40 mx-auto rounded-full mb-4"></div>
                
                <div class="flex flex-col items-center no-export">
                    <div class="inline-flex items-center gap-2 mb-1 px-1 py-0.5 text-[10px] font-bold tracking-widest uppercase text-[#999]">
                        <div v-if="cloudStatus === 'connected'" class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                        <div v-else-if="cloudStatus === 'disconnected'" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                        <i v-else-if="cloudStatus === 'syncing'" data-lucide="refresh-cw" class="w-3 h-3 animate-spin text-[#1893f8]"></i>
                        {{ cloudStatusText }}
                    </div>
                </div>

                <!-- 時間選單 -->
                <div v-if="activeTab === 'home' || activeTab === 'leaderboard'" class="mt-4 no-export w-full px-1 flex gap-3 justify-center items-center animate-in fade-in slide-in-from-top-1 duration-300">
                    <div class="relative w-fit">
                        <select v-model="currentYear" class="appearance-none bg-white border border-[#eee] rounded-full pl-6 pr-10 py-3 text-xs font-black text-[#1893f8] shadow-sm focus:outline-none cursor-pointer text-center min-w-[100px]">
                            <option v-for="y in yearOptions" :key="y" :value="y">{{ y }} 年</option>
                        </select>
                        <i data-lucide="chevron-down" class="text-[#1893f8] absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none w-4 h-4"></i>
                    </div>
                    <div class="relative w-fit">
                        <select v-model="monthFilter" class="appearance-none bg-white border border-[#eee] rounded-full pl-6 pr-10 py-3 text-xs font-black text-[#1893f8] shadow-sm focus:outline-none cursor-pointer text-center min-w-[85px]">
                            <option value="all">全年</option>
                            <option v-for="m in 12" :key="m" :value="m">{{ m }} 月</option>
                        </select>
                        <i data-lucide="chevron-down" class="text-[#1893f8] absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <main class="flex-1">
                <!-- Tab 1: 首頁看板 -->
                <div v-if="activeTab === 'home'" class="flex flex-col gap-6 animate-in fade-in duration-500">
                    <div class="bg-[#1893f8] p-8 rounded-[3rem] text-white shadow-xl relative overflow-hidden max-w-4xl mx-auto w-full border-b-4 border-[#00000020]">
                        <div class="relative z-10 text-center">
                            <div class="flex items-center justify-center gap-2 mb-6">
                                <i data-lucide="trophy" class="w-5 h-5 text-white/80"></i>
                                <h2 class="text-xl font-black tracking-widest uppercase">{{ homeCardTitle }}</h2>
                            </div>
                            <div class="grid grid-cols-2 gap-8 relative">
                                <div class="absolute left-1/2 top-0 bottom-0 w-[1px] bg-white/20 -translate-x-1/2"></div>
                                <div class="relative">
                                    <div class="text-[10px] font-black uppercase opacity-80 mb-1 tracking-widest">Family</div>
                                    <div class="text-3xl md:text-4xl font-black tracking-tighter" :class="stats.familyProfit < 0 ? 'text-[#ff4d4d]' : 'text-white'">
                                        {{ stats.familyProfit >= 0 ? '+' : '' }}{{ (stats.familyProfit || 0).toLocaleString() }}
                                    </div>
                                </div>
                                <div class="relative">
                                    <div class="text-[10px] font-black uppercase opacity-80 mb-1 tracking-widest">Couple</div>
                                    <div class="text-3xl md:text-4xl font-black tracking-tighter" :class="stats.coupleProfit < 0 ? 'text-[#ff4d4d]' : 'text-white'">
                                        {{ stats.coupleProfit >= 0 ? '+' : '' }}{{ (stats.coupleProfit || 0).toLocaleString() }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="homeFilteredPlayers.length > 0" class="grid grid-cols-2 gap-4 md:gap-8 mt-2 max-w-4xl mx-auto w-full">
                        <div v-for="player in homeFilteredPlayers" :key="player.name" 
                             class="bg-white p-5 md:p-8 rounded-[2.5rem] shadow-sm border border-[#eee] flex flex-col active-scale group hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center justify-start gap-2 mb-4">
                                <div class="w-8 h-8 md:w-10 md:h-10 shrink-0 bg-[#f7f6f6] rounded-full flex items-center justify-center text-[#302b28] group-hover:bg-[#1893f8] group-hover:text-white transition-colors">
                                    <i data-lucide="user" class="w-4 h-4 md:w-5 md:h-5"></i>
                                </div>
                                <div class="font-black text-[#302b28] text-base md:text-lg truncate leading-none">{{ player.name }}</div>
                            </div>
                            
                            <div class="mt-1 mb-6 flex flex-col items-center">
                                <div class="text-[10px] md:text-xs font-black text-[#999] bg-[#f7f6f6] px-2 py-0.5 rounded shadow-sm border border-[#eee] mb-2 uppercase leading-none tracking-widest">累計損益</div>
                                <span class="text-3xl md:text-5xl font-black tracking-tighter" :class="getFilteredProfit(player.name) >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'">
                                    {{ getFilteredProfit(player.name) >= 0 ? '+' : '' }}{{ (getFilteredProfit(player.name) || 0).toLocaleString() }}
                                </span>
                            </div>

                            <div class="grid grid-cols-2 gap-1 pt-4 border-t border-[#f7f6f6] w-full mb-6">
                                <div class="text-center">
                                    <div class="text-[8px] md:text-[10px] font-black text-[#999] uppercase mb-0.5 leading-none">贏錢</div>
                                    <div class="text-xs md:text-sm font-black text-[#1893f8] leading-none">+{{ (getHomePlayerStats(player.name).winnings || 0).toLocaleString() }}</div>
                                </div>
                                <div class="text-center border-l border-[#f7f6f6]">
                                    <div class="text-[8px] md:text-[10px] font-black text-[#999] uppercase mb-0.5 leading-none">輸錢</div>
                                    <div class="text-xs md:text-sm font-black text-[#ff4d4d] leading-none">{{ (getHomePlayerStats(player.name).losses || 0).toLocaleString() }}</div>
                                </div>
                            </div>
                            
                            <div class="mt-auto flex flex-col gap-3">
                                <button @click="detailPlayer = player.name" class="w-full py-2.5 bg-[#1893f8] text-white text-[10px] md:text-xs font-black uppercase rounded-2xl shadow-md active-scale no-export flex items-center justify-center gap-2">
                                    <i data-lucide="info" class="w-3 h-3 md:w-4 md:h-4"></i>查看明細
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: 日曆紀錄 -->
                <div v-if="activeTab === 'calendar'" class="flex flex-col gap-6 animate-in fade-in duration-500 max-w-5xl mx-auto">
                    <div class="bg-white rounded-[2rem] md:rounded-[3rem] p-2 sm:p-4 md:p-10 border border-[#eee] shadow-sm overflow-hidden">
                        <div class="text-center mb-4">
                            <h2 class="text-lg md:text-xl font-black text-[#302b28] tracking-[0.1em]">Monthly Records</h2>
                        </div>
                        <div class="flex flex-col md:flex-row items-center justify-center gap-4 px-2 sm:px-4 pb-4 sm:pb-6 mb-2 border-b border-[#f7f6f6]">
                            <div class="flex items-center gap-3 sm:gap-4 w-full md:w-auto justify-center">
                                <button @click="prevMonth" class="w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-full bg-[#1893f8] text-white active-scale shadow-md"><i data-lucide="chevron-left" class="w-5 h-5 sm:w-6 sm:h-6"></i></button>
                                <div class="flex items-center gap-1 bg-[#f7f6f6] px-4 py-2 rounded-2xl text-[#1893f8] font-black shadow-inner leading-none">
                                    <select v-model="currentYear" class="appearance-none bg-transparent border-none px-1 py-1 text-sm sm:text-base font-black focus:ring-0 cursor-pointer text-center leading-none"><option v-for="y in yearOptions" :key="y" :value="y">{{ y }}</option></select>
                                    <span class="text-[#999] font-black text-sm px-1 leading-none">/</span>
                                    <select v-model="currentMonth" class="appearance-none bg-transparent border-none px-1 py-1 text-sm sm:text-base font-black focus:ring-0 cursor-pointer text-center leading-none"><option v-for="(m, idx) in 12" :key="m" :value="idx">{{ m }}</option></select>
                                </div>
                                <button @click="nextMonth" class="w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-full bg-[#1893f8] text-white active-scale shadow-md"><i data-lucide="chevron-right" class="w-5 h-5 sm:w-6 sm:h-6"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-4 mt-6">
                            <div v-for="d in ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']" :key="d" class="text-center text-[9px] sm:text-[10px] md:text-xs font-black tracking-widest text-[#1893f8] opacity-50 uppercase leading-none">{{ d }}</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 md:gap-3 mb-4">
                            <div v-for="empty in firstDayOfMonth" :key="'e-'+empty" class="min-h-[60px] sm:min-h-[80px]"></div>
                            <button v-for="day in daysInMonth" :key="day" @click="handleDateClick(day)"
                                class="min-h-[105px] sm:min-h-[135px] md:min-h-[175px] h-auto rounded-2xl md:rounded-3xl flex flex-col items-center py-2 sm:py-3 md:py-4 transition-all relative active-scale bg-white border shadow-sm"
                                :class="records[formatDateKey(currentYear, currentMonth + 1, day)] ? 'border-2 border-[#1893f8] shadow-md z-10' : 'border-[#eee]'">
                                <span class="text-[12px] sm:text-sm md:text-lg font-black mb-1 md:mb-3" :class="records[formatDateKey(currentYear, currentMonth + 1, day)] ? 'text-[#1893f8]' : 'text-[#999]'">{{ day }}</span>
                                <div v-if="records[formatDateKey(currentYear, currentMonth + 1, day)]" class="flex flex-col w-full px-1 sm:px-1.5 md:px-2 gap-1 md:gap-1.5 mt-0.5 md:mt-1">
                                    <div v-for="target in ['阿如', '阿瑋']" :key="target" class="w-full font-black flex flex-col items-center justify-center px-0.5 sm:px-1 py-1 sm:py-2 md:py-3.5 rounded-lg md:rounded-2xl leading-none shadow-sm transition-all"
                                        :class="getDailyMergedScore(formatDateKey(currentYear, currentMonth + 1, day), target) > 0 ? 'bg-[#1893f8]/10 text-[#1893f8]' : getDailyMergedScore(formatDateKey(currentYear, currentMonth + 1, day), target) < 0 ? 'bg-[#ff4d4d]/10 text-[#ff4d4d]' : 'bg-gray-100 text-gray-500'">
                                        <span class="text-[8px] sm:text-[10px] md:text-[13px] truncate w-full text-center mb-0.5 md:mb-1 opacity-70 leading-none">{{ target }}</span>
                                        <span class="font-mono text-[9px] sm:text-[11px] md:text-[15px] truncate w-full text-center font-black leading-none">{{ (getDailyMergedScore(formatDateKey(currentYear, currentMonth + 1, day), target) || 0) > 0 ? '+' : '' }}{{ (getDailyMergedScore(formatDateKey(currentYear, currentMonth + 1, day), target) || 0) }}</span>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 日曆下方的月統計排行 (修復) -->
                    <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-6 md:p-8 shadow-sm border border-[#eee] mt-4 space-y-8 animate-in fade-in duration-500">
                        <div class="flex items-center justify-center gap-2 border-b border-[#f7f6f6] pb-5"><i data-lucide="award" class="w-6 h-6 text-[#1893f8]"></i><h3 class="text-lg font-black text-[#302b28]">{{ currentMonth + 1 }}月 數據總覽</h3></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-3">
                                <div class="text-[11px] font-black text-[#999] uppercase text-center mb-4 tracking-widest leading-none">個人月盈虧</div>
                                <div v-for="p in filteredMonthlyStats" :key="p.name" class="flex justify-between items-center bg-[#f7f6f6] px-5 py-3 rounded-2xl text-sm font-bold shadow-sm leading-none">
                                    <span class="text-[#302b28] leading-none">{{ p.name }}</span>
                                    <span :class="p.totalProfit >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'" class="leading-none">{{ p.totalProfit > 0 ? '+' : '' }}{{ (p.totalProfit || 0).toLocaleString() }}</span>
                                </div>
                            </div>
                            <div class="space-y-3 md:border-l md:border-[#f7f6f6] md:pl-8">
                                <div class="text-[11px] font-black text-[#999] uppercase text-center mb-4 tracking-widest leading-none">本月排行</div>
                                <div v-for="(p, idx) in filteredMonthlyStats" :key="p.name" class="flex items-center gap-4 bg-[#f7f6f6] px-5 py-3 rounded-2xl text-sm font-bold shadow-sm leading-none">
                                    <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-black shadow-md shrink-0 leading-none"
                                        :style="{ backgroundColor: idx === 0 ? '#FFD700' : idx === 1 ? '#A0A0A0' : idx === 2 ? '#CD7F32' : '#ffffff', color: idx < 3 ? 'white' : '#999' }">
                                        {{ idx + 1 }}
                                    </span>
                                    <span class="flex-1 truncate leading-none">{{ p.name }}</span>
                                    <span :class="p.totalProfit >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'" class="leading-none">{{ (p.totalProfit || 0).toLocaleString() }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: 排行分頁 -->
                <div v-if="activeTab === 'leaderboard'" class="flex flex-col gap-6 animate-in fade-in duration-500 max-w-4xl mx-auto w-full transition-all">
                    <div class="bg-white rounded-[3rem] shadow-sm border border-[#eee] p-8 md:p-12">
                        <div class="flex flex-col items-center justify-center gap-6 mb-10 border-b border-[#f7f6f6] pb-8">
                            <div class="flex items-center gap-3"><i data-lucide="award" class="w-8 h-8 text-[#1893f8]"></i><h3 class="text-2xl font-black text-[#302b28]">英雄榜</h3></div>
                            <div class="flex flex-wrap justify-center bg-[#f7f6f6] p-1.5 rounded-2xl no-export w-fit shadow-inner gap-2">
                                <button @click="leaderboardTab = 'all'" class="px-8 py-2 rounded-xl text-xs font-black transition-all" :class="leaderboardTab === 'all' ? 'bg-[#1893f8] text-white shadow-md' : 'text-[#999]'">總排行</button>
                                <button @click="leaderboardTab = 'kinship'" class="px-8 py-2 rounded-xl text-xs font-black transition-all" :class="leaderboardTab === 'kinship' ? 'bg-[#1893f8] text-white shadow-md' : 'text-[#999]'">親情榜</button>
                            </div>
                        </div>

                        <div class="flex flex-col gap-10 sm:gap-12">
                            <div v-for="(item, idx) in displayLeaderboard" :key="item.name" class="relative flex flex-col p-8 sm:p-10 rounded-[3rem] bg-[#f7f6f6]/50 border border-transparent hover:bg-white hover:border-[#eee] hover:shadow-xl transition-all duration-300 text-center sm:text-left">
                                <div class="absolute -top-3 -left-1 sm:-top-5 sm:-left-3 text-5xl sm:text-7xl font-black italic select-none pointer-events-none drop-shadow-sm opacity-90" 
                                    :style="{ color: idx === 0 ? '#FFD700' : idx === 1 ? '#A0A0A0' : idx === 2 ? '#CD7F32' : '#d1d1d1' }">
                                    {{ idx + 1 }}
                                </div>
                                <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-between gap-4 mb-6 relative z-10 w-full">
                                    <div class="flex flex-col sm:flex-row items-center gap-4 overflow-hidden sm:pl-8">
                                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-[#302b28] shadow-sm shrink-0"><i data-lucide="user" class="w-6 h-6"></i></div>
                                        <span class="font-black text-[#302b28] text-xl truncate leading-none">{{ item.name }}</span>
                                    </div>
                                    <div class="relative mt-2 sm:mt-0 leading-none">
                                        <span class="text-4xl font-black tracking-tighter" :class="item.totalProfit >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'">{{ item.totalProfit > 0 ? '+' : '' }}{{ (item.totalProfit || 0).toLocaleString() }}</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mt-2 mb-6 bg-white/60 p-5 rounded-3xl text-center shadow-inner relative z-10">
                                    <div><div class="text-[10px] font-black text-[#999] uppercase mb-1 tracking-widest leading-none">獲利統計</div><div class="text-xl font-black text-[#1893f8] leading-none">+{{ (item.totalWinnings || 0).toLocaleString() }}</div></div>
                                    <div class="border-l border-[#eee]"><div class="text-[10px] font-black text-[#999] uppercase mb-1 tracking-widest leading-none">損失統計</div><div class="text-xl font-black text-[#ff4d4d] leading-none">{{ (item.totalLosses || 0).toLocaleString() }}</div></div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 py-4 border-t border-white/60 items-center relative z-10">
                                    <div class="flex flex-col items-center leading-none"><span class="text-sm font-black text-[#302b28] mb-1 leading-none">{{ item.participateCount }}場</span><span class="text-[8px] text-[#999] font-black uppercase tracking-widest leading-none">紀錄</span></div>
                                    <div class="flex flex-col items-center border-x border-[#eee] leading-none"><span class="text-sm font-black text-emerald-500 mb-1 leading-none">{{ item.winRate }}%</span><span class="text-[8px] text-[#999] font-black uppercase tracking-widest leading-none">勝率</span></div>
                                    <button @click="detailPlayer = item.name" class="text-xs font-black text-[#1893f8] active-scale hover:underline">詳情紀錄</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 懸浮導覽列 (修復消失) -->
        <div class="fixed bottom-0 left-0 right-0 z-40 bg-gradient-to-t from-[#f7f6f6] via-[#f7f6f6] to-transparent pt-4 pb-[env(safe-area-inset-bottom)] no-export">
            <div class="max-w-[320px] md:max-w-[400px] mx-auto mb-8 px-4">
                <div class="bg-white/90 backdrop-blur-2xl p-1.5 rounded-[2.5rem] border border-[#eee] shadow-2xl flex items-center gap-1.5">
                    <button @click="activeTab = 'home'" class="flex-1 py-3 rounded-[2rem] text-sm font-bold transition-all" :class="activeTab === 'home' ? 'bg-[#e55039] text-white shadow-lg' : 'text-[#999] hover:bg-[#f7f6f6]'">首頁</button>
                    <button @click="activeTab = 'calendar'" class="flex-1 py-3 rounded-[2rem] text-sm font-bold transition-all" :class="activeTab === 'calendar' ? 'bg-[#1893f8] text-white shadow-lg' : 'text-[#999] hover:bg-[#f7f6f6]'">日曆</button>
                    <button @click="activeTab = 'leaderboard'" class="flex-1 py-3 rounded-[2rem] text-sm font-bold transition-all" :class="activeTab === 'leaderboard' ? 'bg-[#1893f8] text-white shadow-lg' : 'text-[#999] hover:bg-[#f7f6f6]'">排行</button>
                </div>
            </div>
        </div>

        <!-- 錄入戰報彈窗 (含管理入口) -->
        <transition name="fade">
            <div v-if="isModalOpen" class="fixed inset-0 bg-[#302b28]/70 backdrop-blur-md flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
                <div class="bg-white rounded-t-[3rem] sm:rounded-[3rem] w-full max-w-3xl max-h-[92vh] overflow-y-auto shadow-2xl p-6 sm:p-10 pb-[calc(2rem+env(safe-area-inset-bottom))] relative no-scrollbar">
                    <div class="flex justify-between items-start mb-8 pb-5 border-b border-[#f7f6f6]">
                        <div>
                            <h3 class="text-2xl font-black text-[#1893f8]">{{ viewMode === 'edit' ? (editingSessionId ? '編輯場次' : '錄入新場次') : '當日戰報清單' }}</h3>
                            <input v-if="viewMode === 'edit' && !editingSessionId" type="date" v-model="selectedDate" class="mt-3 text-base font-black bg-[#f7f6f6] px-4 py-2 rounded-xl border-none shadow-sm focus:ring-2 ring-[#1893f8]">
                            <p v-else class="text-xs font-bold text-[#999] mt-2 tracking-widest uppercase leading-none">{{ selectedDate }}</p>
                        </div>
                        <button @click="isModalOpen = false" class="w-12 h-12 flex items-center justify-center rounded-full bg-[#f7f6f6] text-[#999] active-scale shadow-inner"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>

                    <div v-if="viewMode === 'edit'" class="space-y-8">
                        <!-- PIN CODE 驗證 -->
                        <div v-if="!isVerified" class="py-16 flex flex-col items-center justify-center text-center">
                            <i data-lucide="lock" class="w-16 h-16 text-[#1893f8] mb-6"></i>
                            <h4 class="font-black text-xl mb-8 uppercase tracking-widest leading-none">PIN CODE 驗證</h4>
                            <div class="w-full max-w-[240px]">
                                <input type="password" v-model="passwordInput" placeholder="••••" 
                                    :class="{'shake border-red-500': passwordError}"
                                    class="w-full bg-[#f7f6f6] rounded-[2rem] px-6 py-5 text-center text-2xl font-black border-none transition-all shadow-inner focus:ring-4 ring-[#1893f8]/20" 
                                    @keyup.enter="checkPassword">
                                <button @click="checkPassword" class="w-full py-5 bg-[#1893f8] text-white rounded-[2rem] font-black active-scale shadow-xl mt-4">確認進入</button>
                            </div>
                        </div>
                        
                        <div v-else class="space-y-8 animate-in fade-in duration-300">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><label class="text-[11px] font-black text-[#999] block mb-3 uppercase tracking-widest leading-none">籌碼規格</label><select v-model="formData.stakes" class="w-full bg-[#f7f6f6] rounded-2xl px-5 py-4 text-sm font-bold border-none shadow-sm"><option value="30/10">30/10</option><option value="50/20">50/20</option><option value="100/20">100/20</option></select></div>
                                <div><label class="text-[11px] font-black text-[#999] block mb-3 uppercase tracking-widest leading-none">打幾將</label><input type="number" step="0.5" v-model="formData.rounds" class="w-full bg-[#f7f6f6] rounded-2xl px-5 py-4 text-sm font-bold border-none shadow-inner"></div>
                                <div>
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="text-[11px] font-black text-[#999] uppercase tracking-widest leading-none">地點</label>
                                        <button @click="isLocationMgrOpen = true" class="text-[9px] font-black text-[#1893f8] uppercase underline tracking-tighter">管理地點</button>
                                    </div>
                                    <input type="text" v-model="formData.location" placeholder="..." class="w-full bg-[#f7f6f6] rounded-2xl px-5 py-4 text-sm font-bold border-none shadow-inner mb-2">
                                    <div class="flex flex-wrap gap-2">
                                        <div v-for="loc in allHistoryLocations" :key="loc" 
                                            @click="toggleLocationInSession(loc)"
                                            class="group relative flex items-center rounded-full border transition-all active-scale shadow-sm px-3 py-1 cursor-pointer"
                                            :class="formData.location === loc ? 'bg-[#1893f8] text-white border-[#1893f8] shadow-md' : 'bg-white text-[#999] border-[#eee]'">
                                            <span class="text-[10px] font-bold leading-none">{{ loc }}</span>
                                        </div>
                                    </div>
                                </div>
                             </div>

                             <div class="bg-[#f7f6f6] p-6 rounded-[2.5rem]">
                                <div class="flex flex-col gap-4 mb-6">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[11px] font-black text-[#999] uppercase tracking-widest leading-none">參與玩家 (加入/移除)</label>
                                        <button @click="isPlayerMgrOpen = true" class="text-[9px] font-black text-[#1893f8] uppercase underline tracking-tighter">管理名單</button>
                                    </div>
                                    <div class="flex flex-wrap gap-2 border-b border-white pb-4 mb-2">
                                        <button v-for="p in players" :key="p.name" 
                                            @click="togglePlayerInSession(p.name)"
                                            :class="formData.playerStats[p.name] !== undefined ? 'bg-[#1893f8] text-white border-[#1893f8] shadow-md' : 'bg-white text-[#999] border-[#eee]'"
                                            class="px-4 py-2 rounded-full text-xs font-bold border transition-all active-scale leading-none">
                                            {{ p.name }}
                                        </button>
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" placeholder="手動新增玩家" v-model="newPlayerName" @keypress.enter="handleAddNewPlayer" class="flex-1 bg-white rounded-xl px-4 py-2 text-xs font-bold border-none shadow-sm">
                                        <button @click="handleAddNewPlayer" class="bg-[#1893f8] text-white p-2 rounded-xl active-scale shadow-md"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div v-for="(val, pName) in formData.playerStats" :key="pName" class="bg-white p-4 rounded-3xl flex flex-col gap-3 shadow-sm border border-white transition-all">
                                        <div class="flex justify-between items-start">
                                            <div class="flex flex-col gap-1 overflow-hidden">
                                                <div class="flex items-center gap-2 leading-none mb-1">
                                                    <button @click="togglePlayerInSession(pName)" class="text-[#ccc] hover:text-[#ff4d4d] transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                                                    <span class="font-black text-sm truncate leading-none">{{ pName }}</span>
                                                </div>
                                                <div class="flex gap-1 overflow-x-auto no-scrollbar">
                                                    <button v-for="cat in categoryOptions" :key="cat.value" @click="updatePlayerCategory(pName, cat.value)" class="category-chip py-1 shadow-sm" :class="getPlayerCategories(pName).includes(cat.value) ? 'bg-[#302b28] text-white border-[#302b28]' : 'bg-[#f7f6f6] text-[#ccc] border-[#eee]'">{{ cat.label }}</button>
                                                </div>
                                            </div>
                                            <div class="flex gap-1 shrink-0"><button @click="toggleWinLoss(pName, 'win')" :class="val > 0 ? 'bg-[#1893f8] text-white shadow-md' : 'bg-[#f7f6f6] text-[#999]'" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all">贏</button><button @click="toggleWinLoss(pName, 'loss')" :class="val < 0 ? 'bg-[#ff4d4d] text-white shadow-md' : 'bg-[#f7f6f6] text-[#999]'" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all">輸</button></div>
                                        </div>
                                        <input type="number" :value="Math.abs(val)" @input="updateStat(pName, $event.target.value)" class="bg-[#f7f6f6] border-none rounded-xl px-4 py-3 text-right font-black shadow-inner leading-none">
                                    </div>
                                </div>
                             </div>
                             
                             <div class="flex flex-col gap-4">
                                <div class="flex gap-4">
                                    <button @click="viewMode = records[selectedDate] ? 'preview' : 'edit'; if(!records[selectedDate]) isModalOpen = false" class="flex-1 py-5 rounded-[2rem] bg-[#f7f6f6] text-[#999] font-black active-scale transition-colors shadow-inner leading-none">取消</button>
                                    <button @click="saveSession" class="flex-[2] py-5 rounded-[2rem] bg-[#1893f8] text-white font-black active-scale shadow-xl leading-none">儲存戰報資料</button>
                                </div>
                                <div v-if="editingSessionId" class="pt-4 border-t border-[#eee]">
                                    <div v-if="!showDeleteConfirm" @click="showDeleteConfirm = true" class="w-full py-4 text-[#ff4d4d] text-sm font-black text-center flex items-center justify-center gap-2 cursor-pointer active-scale opacity-70 leading-none"><i data-lucide="trash-2" class="w-4 h-4"></i> 刪除此場次紀錄</div>
                                    <div v-else class="flex gap-4 animate-in slide-in-from-bottom-2"><button @click="showDeleteConfirm = false" class="flex-1 py-4 bg-[#f7f6f6] rounded-2xl text-[#999] text-xs font-black shadow-inner leading-none">取消</button><button @click="deleteSession" class="flex-[2] py-4 bg-[#ff4d4d] rounded-2xl text-white text-xs font-black shadow-lg leading-none">確認刪除</button></div>
                                </div>
                             </div>
                        </div>
                    </div>

                    <div v-else class="space-y-6 animate-in fade-in duration-300">
                        <div v-if="records[selectedDate] && records[selectedDate].sessions" class="space-y-4">
                             <div v-for="sess in records[selectedDate].sessions" :key="sess.id" class="bg-[#f7f6f6] rounded-[2rem] p-6 border border-[#eee] hover:border-[#1893f8] transition-all shadow-sm">
                                <div class="flex justify-between items-start mb-4 leading-none">
                                    <div><p class="text-[10px] text-[#999] font-black uppercase mb-1 tracking-widest leading-none">對戰明細</p><p class="font-bold text-[#302b28] leading-none">{{ sess.stakes }} • {{ sess.rounds }}將 • {{ sess.location || '未標註' }}</p></div>
                                    <div class="flex gap-2">
                                        <button @click="startEditSession(sess)" class="bg-white px-4 py-2 rounded-xl text-xs font-black text-[#1893f8] shadow-sm border border-[#eee] active-scale leading-none">編輯</button>
                                        <button @click="confirmDeleteSessFromList(sess.id)" class="bg-white px-4 py-2 rounded-xl text-xs font-black text-[#ff4d4d] shadow-sm border border-[#eee] active-scale leading-none">刪除</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 leading-none">
                                    <div v-for="p in getSortedPlayerStats(sess.playerStats)" :key="p.name" class="flex flex-col text-center p-2 bg-white rounded-xl shadow-sm border border-white leading-none">
                                        <span class="text-[8px] text-[#999] font-bold truncate leading-none mb-1">{{ p.name }}</span>
                                        <span :class="p.val >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'" class="font-black text-xs leading-none">{{ p.val > 0 ? '+' : '' }}{{ p.val }}</span>
                                    </div>
                                </div>
                             </div>
                        </div>
                        <button @click="addNewSession" class="w-full py-5 rounded-[2rem] bg-[#1893f8] text-white font-black shadow-xl active-scale flex items-center justify-center gap-2 leading-none"><i data-lucide="plus" class="w-5 h-5"></i> 新增另一場戰報</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 管理玩家 Modal -->
        <transition name="fade">
            <div v-if="isPlayerMgrOpen" class="fixed inset-0 bg-[#302b28]/80 backdrop-blur-md flex items-center justify-center z-[120] p-4">
                <div class="bg-white rounded-[2.5rem] w-full max-w-xl shadow-2xl max-h-[80vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-300">
                    <div class="p-8 pb-5 flex justify-between items-center border-b border-[#f7f6f6]">
                        <div class="flex items-center gap-4"><i data-lucide="users" class="w-6 h-6 text-[#1893f8]"></i><h3 class="text-xl font-black leading-none">系統玩家管理</h3></div>
                        <button @click="isPlayerMgrOpen = false" class="w-10 h-10 rounded-full bg-[#f7f6f6] flex items-center justify-center text-[#999] active-scale transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-3 no-scrollbar">
                        <div v-for="p in players" :key="p.name" class="flex items-center justify-between bg-[#f7f6f6] p-4 rounded-3xl border border-transparent hover:border-[#eee] transition-all">
                            <span class="font-black text-[#302b28] truncate flex-1 leading-none">{{ p.name }}</span>
                            <div class="flex gap-2 shrink-0">
                                <button @click="renameGlobalPlayer(p.name)" class="p-2 bg-white rounded-xl text-[#1893f8] shadow-sm active-scale transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button @click="deleteGlobalPlayer(p.name)" class="p-2 bg-white rounded-xl text-[#ff4d4d] shadow-sm active-scale transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 管理地點 Modal -->
        <transition name="fade">
            <div v-if="isLocationMgrOpen" class="fixed inset-0 bg-[#302b28]/80 backdrop-blur-md flex items-center justify-center z-[120] p-4">
                <div class="bg-white rounded-[2.5rem] w-full max-w-xl shadow-2xl max-h-[80vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-300">
                    <div class="p-8 pb-5 flex justify-between items-center border-b border-[#f7f6f6]">
                        <div class="flex items-center gap-4"><i data-lucide="map-pin" class="w-6 h-6 text-[#1893f8]"></i><h3 class="text-xl font-black leading-none">系統地點管理</h3></div>
                        <button @click="isLocationMgrOpen = false" class="w-10 h-10 rounded-full bg-[#f7f6f6] flex items-center justify-center text-[#999] active-scale transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-3 no-scrollbar">
                        <div v-for="loc in allHistoryLocations" :key="loc" class="flex items-center justify-between bg-[#f7f6f6] p-4 rounded-3xl border border-transparent hover:border-[#eee] transition-all">
                            <span class="font-black text-[#302b28] truncate flex-1 leading-none">{{ loc }}</span>
                            <div class="flex gap-2 shrink-0">
                                <button @click="renameLocationGlobalAll(loc)" class="p-2 bg-white rounded-xl text-[#1893f8] shadow-sm active-scale transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button @click="deleteLocationGlobalAll(loc)" class="p-2 bg-white rounded-xl text-[#ff4d4d] shadow-sm active-scale transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 個人詳情 Modal (唯讀模式) -->
        <transition name="fade">
            <div v-if="detailPlayer" class="fixed inset-0 bg-[#302b28]/80 backdrop-blur-md flex items-center justify-center z-[110] p-4">
                <div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] w-full max-w-2xl shadow-2xl max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-300">
                    <div class="p-8 md:p-10 pb-5 flex justify-between items-center border-b border-[#f7f6f6]">
                        <div class="flex items-center gap-4"><i data-lucide="user" class="w-6 h-6 text-[#1893f8]"></i><h3 class="text-xl font-black leading-none">{{ detailPlayer }} 戰報詳情</h3></div>
                        <button @click="detailPlayer = null" class="w-10 h-10 rounded-full bg-[#f7f6f6] flex items-center justify-center text-[#999] active-scale transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 md:p-10 space-y-8 no-scrollbar">
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-[#999] mb-2 leading-none"><i data-lucide="map-pin" class="w-3 h-3"></i><span class="text-[10px] font-black uppercase tracking-widest">福地戰績統計</span></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div v-for="(stat, loc) in getLocationStats(detailPlayer)" :key="loc" class="bg-[#201f1f] text-white p-5 rounded-[1.5rem] shadow-lg border border-white/10 relative overflow-hidden group">
                                    <div class="relative z-10 flex justify-between items-end mb-2 leading-none">
                                        <div class="flex-1 truncate pr-2 leading-none">
                                            <h4 class="text-xs font-black text-white/60 truncate mb-1 leading-none">{{ loc }}</h4>
                                            <p class="text-2xl font-black leading-none">{{ stat.winRate }}%</p>
                                        </div>
                                        <div class="text-right shrink-0 leading-none"><span class="text-[9px] font-bold bg-white/10 px-2 py-0.5 rounded-full tracking-tighter uppercase leading-none">{{ stat.total }} 場</span></div>
                                    </div>
                                    <div class="h-1 w-full bg-white/10 rounded-full relative z-10 leading-none"><div class="h-full bg-[#1893f8] rounded-full transition-all duration-1000" :style="{ width: stat.winRate + '%' }"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-[#999] mb-2 leading-none"><i data-lucide="list" class="w-3 h-3"></i><span class="text-[10px] font-black uppercase tracking-widest">歷史紀錄清單</span></div>
                            <div v-for="(h, i) in getPlayerHistory(detailPlayer)" :key="i" class="bg-[#f7f6f6] rounded-2xl p-5 flex flex-col border border-transparent leading-none shadow-sm shadow-inner">
                                <div class="flex justify-between items-center w-full leading-none">
                                    <div class="flex-1 leading-none">
                                        <div class="text-sm font-black mb-1 flex items-center gap-2 leading-none">{{ h.date }}<span class="text-[10px] bg-[#1893f8]/10 text-[#1893f8] px-2 py-0.5 rounded shadow-sm leading-none">{{ h.stakes }}</span></div>
                                        <div class="text-[10px] text-[#999] font-bold leading-none">{{ h.location }}</div>
                                    </div>
                                    <div class="flex items-center gap-4 leading-none">
                                        <div :class="h.amount >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'" class="text-2xl font-black tracking-tighter leading-none">{{ (h.amount || 0).toLocaleString() }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 當月明細 Modal -->
        <transition name="fade">
            <div v-if="isMonthDetailOpen" class="fixed inset-0 bg-[#302b28]/80 backdrop-blur-md flex items-center justify-center z-[110] p-4">
                <div class="bg-white rounded-[3rem] w-full max-w-2xl shadow-2xl max-h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-300">
                    <div class="p-8 pb-5 flex justify-between items-center border-b border-[#f7f6f6]">
                        <div class="flex items-center gap-4"><i data-lucide="file-text" class="w-6 h-6 text-[#1893f8]"></i><h3 class="text-xl font-black leading-none">當月戰鬥明細</h3></div>
                        <button @click="isMonthDetailOpen = false" class="w-10 h-10 rounded-full bg-[#f7f6f6] flex items-center justify-center text-[#999] active-scale transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                        <template v-for="(rec, date) in currentMonthRecords" :key="date">
                            <div v-for="sess in rec.sessions" :key="sess.id" class="bg-[#f7f6f6] rounded-3xl p-5 border border-transparent leading-none shadow-sm">
                                <div class="flex justify-between items-start mb-4 pb-2 border-b border-white leading-none"><div class="text-sm font-black text-[#302b28] leading-none">{{ date }}</div><div class="text-[10px] text-[#999] font-bold leading-none">{{ sess.stakes }} • {{ sess.rounds }}將</div></div>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 leading-none">
                                    <div v-for="p in getSortedPlayerStats(sess.playerStats)" :key="p.name" class="flex flex-col text-center p-2 bg-white rounded-xl shadow-sm border border-white leading-none">
                                        <span class="text-[8px] text-[#999] font-bold truncate leading-none mb-1">{{ p.name }}</span>
                                        <span :class="p.val >= 0 ? 'text-[#1893f8]' : 'text-[#ff4d4d]'" class="font-black text-xs leading-none">{{ p.val > 0 ? '+' : '' }}{{ p.val }}</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB_Wc8n7-3AZzDCPRv6DLqjRTeyk9xmyzE",
            authDomain: "mahjong-2026-c108b.firebaseapp.com",
            projectId: "mahjong-2026-c108b",
            storageBucket: "mahjong-2026-c108b.firebasestorage.app",
            messagingSenderId: "106415682280",
            appId: "1:106415682280:web:7ee800ae2e789d45eecf5d"
        };

        const { createApp, ref, computed, onMounted, watch } = Vue;

        const app = createApp({
            setup() {
                // --- 1. 輔助函式 (必須置頂宣告) ---
                const normalizeDateString = (str) => { if (!str || typeof str !== 'string') return str; const parts = str.split('-'); return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`; };
                const formatDateKey = (y, m, d) => `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const ensureCategoryArray = (cat) => Array.isArray(cat) ? cat : (typeof cat === 'string' ? [cat] : ['other']);

                // --- 2. 狀態宣告 ---
                const appId = ref('mahjong-tracker-2026');
                const user = ref(null);
                const activeTab = ref('calendar');
                const monthFilter = ref('all');
                const currentYear = ref(new Date().getFullYear());
                const currentMonth = ref(new Date().getMonth());
                const leaderboardTab = ref('all');
                const records = ref({});
                const players = ref([]);
                const isVerified = ref(false);
                const isPlayerMgrOpen = ref(false);
                const isLocationMgrOpen = ref(false);
                const passwordInput = ref('');
                const passwordError = ref(false);
                const isModalOpen = ref(false);
                const isMonthDetailOpen = ref(false);
                const viewMode = ref('preview');
                const selectedDate = ref('');
                const detailPlayer = ref(null);
                const cloudStatus = ref('disconnected');
                const showDeleteConfirm = ref(false);
                const editingSessionId = ref(null);
                const formData = ref({ id: '', stakes: '30/10', location: '', rounds: '1', playerStats: {} });
                const newPlayerName = ref('');
                const categoryOptions = [ { label: '家人', value: 'family' }, { label: '情人', value: 'couple' }, { label: '其他', value: 'other' } ];

                // --- 3. 核心運算邏輯 ---
                const getPlayerCategories = (name) => { const p = players.value.find(pl => String(pl.name).trim() === String(name).trim()); return ensureCategoryArray(p?.category); };
                const getDailyMergedScore = (date, name) => { const rec = records.value[date]; if (!rec || !rec.sessions) return null; let total = 0; let found = false; rec.sessions.forEach(sess => { if (sess.playerStats && sess.playerStats[name] !== undefined) { total += sess.playerStats[name]; found = true; } }); return found ? total : null; };
                const getSortedPlayerStats = (stats) => { if (!stats) return []; return Object.entries(stats).map(([name, val]) => ({ name, val })).sort((a, b) => { if (a.name === '阿如') return -1; if (b.name === '阿如') return 1; return 0; }); };

                // --- 4. 管理功能 (保證回傳且與 UI 對接) ---
                const renameGlobalPlayer = async (oldName) => {
                    const newName = window.prompt(`將【${oldName}】修改為新名稱：`, oldName);
                    if (!newName || newName === oldName) return;
                    cloudStatus.value = 'syncing';
                    try {
                        const updatedList = players.value.map(p => p.name === oldName ? { ...p, name: newName } : p);
                        await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'players_metadata', 'players_list'), { list: updatedList });
                        for (const date in records.value) {
                            const rec = records.value[date]; if (rec.sessions) {
                                const newSess = rec.sessions.map(s => {
                                    if (s.playerStats && s.playerStats[oldName] !== undefined) {
                                        const newStats = { ...s.playerStats }; newStats[newName] = newStats[oldName]; delete newStats[oldName];
                                        return { ...s, playerStats: newStats };
                                    }
                                    return s;
                                });
                                await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'records', date), { sessions: newSess });
                            }
                        }
                        cloudStatus.value = 'connected';
                    } catch (e) { cloudStatus.value = 'disconnected'; }
                };

                const deleteGlobalPlayer = async (name) => {
                    if(!confirm(`確定要永久刪除玩家【${name}】嗎？`)) return;
                    cloudStatus.value = 'syncing';
                    const updatedList = players.value.filter(p => p.name !== name);
                    await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'players_metadata', 'players_list'), { list: updatedList });
                    cloudStatus.value = 'connected';
                };

                const renameLocationGlobalAll = async (oldLoc) => {
                    const newLoc = window.prompt(`將地點【${oldLoc}】修改為新名稱：`, oldLoc);
                    if (!newLoc || newLoc === oldLoc) return;
                    cloudStatus.value = 'syncing';
                    try {
                        for (const date in records.value) {
                            const rec = records.value[date]; if (rec.sessions) {
                                const newSessions = rec.sessions.map(s => { if (s.location?.trim() === oldLoc) { return { ...s, location: newLoc }; } return s; });
                                await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'records', date), { sessions: newSessions });
                            }
                        }
                        cloudStatus.value = 'connected';
                    } catch (e) { cloudStatus.value = 'disconnected'; }
                };

                const deleteLocationGlobalAll = async (oldLoc) => {
                    if (!confirm(`確定要清除地點標記【${oldLoc}】嗎？`)) return;
                    cloudStatus.value = 'syncing';
                    try {
                        for (const date in records.value) {
                            const rec = records.value[date]; if (rec.sessions) {
                                const newSessions = rec.sessions.map(s => { if (s.location?.trim() === oldLoc) { return { ...s, location: '' }; } return s; });
                                await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'records', date), { sessions: newSessions });
                            }
                        }
                        cloudStatus.value = 'connected';
                    } catch (e) { cloudStatus.value = 'disconnected'; }
                };

                // --- 5. 錄入與系統函式 ---
                const handleManualRefresh = () => { cloudStatus.value = 'syncing'; fetchData(); setTimeout(() => { if(user.value) cloudStatus.value = 'connected'; }, 1000); };
                const handleQuickAdd = () => { const now = new Date(); selectedDate.value = formatDateKey(now.getFullYear(), now.getMonth()+1, now.getDate()); isVerified.value = false; addNewSession(); };
                const handleDateClick = (day) => { const standardKey = formatDateKey(currentYear.value, currentMonth.value + 1, day); selectedDate.value = standardKey; if (records.value[standardKey]?.sessions?.length) { viewMode.value = 'preview'; } else { addNewSession(); } isModalOpen.value = true; };
                const checkPassword = () => { if (passwordInput.value === '0302') { isVerified.value = true; passwordError.value = false; passwordInput.value = ''; } else { passwordError.value = true; setTimeout(() => passwordError.value = false, 500); } };

                const togglePlayerInSession = (pName) => { const stats = { ...formData.value.playerStats }; if (stats[pName] !== undefined) { delete stats[pName]; } else { stats[pName] = 0; } formData.value.playerStats = stats; };
                const toggleLocationInSession = (loc) => { if (formData.value.location === loc) { formData.value.location = ''; } else { formData.value.location = loc; } };
                const handleAddNewPlayer = async () => {
                    const name = newPlayerName.value.trim(); if (!user.value || !name) return;
                    if (!players.value.find(p => p.name === name)) {
                        const updatedList = [...players.value, { name, category: ['other'] }];
                        await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'players_metadata', 'players_list'), { list: updatedList });
                    }
                    formData.value.playerStats = { ...formData.value.playerStats, [name]: 0 };
                    newPlayerName.value = '';
                };

                const deleteSession = async () => { cloudStatus.value = 'syncing'; try { const dateDocRef = doc(db, 'artifacts', appId.value, 'public', 'data', 'records', selectedDate.value); const updatedSessions = (records.value[selectedDate.value]?.sessions || []).filter(s => s.id !== editingSessionId.value); if (updatedSessions.length === 0) { await deleteDoc(dateDocRef); } else { await setDoc(dateDocRef, { sessions: updatedSessions }); } isModalOpen.value = false; cloudStatus.value = 'connected'; } catch (e) { cloudStatus.value = 'disconnected'; } };
                const confirmDeleteSessFromList = async (sessId) => { if (!confirm("確定要刪除這場紀錄嗎？")) return; cloudStatus.value = 'syncing'; try { const dateDocRef = doc(db, 'artifacts', appId.value, 'public', 'data', 'records', selectedDate.value); const updatedSessions = (records.value[selectedDate.value]?.sessions || []).filter(s => s.id !== sessId); if (updatedSessions.length === 0) { await deleteDoc(dateDocRef); } else { await setDoc(dateDocRef, { sessions: updatedSessions }); } cloudStatus.value = 'connected'; } catch (e) { cloudStatus.value = 'disconnected'; } };
                const saveSession = async () => { cloudStatus.value = 'syncing'; try { const dateDocRef = doc(db, 'artifacts', appId.value, 'public', 'data', 'records', selectedDate.value); let sessions = (records.value[selectedDate.value]?.sessions || []); const sessionData = JSON.parse(JSON.stringify(formData.value)); if (editingSessionId.value) { sessions = sessions.map(s => s.id === editingSessionId.value ? sessionData : s); } else { sessions.push(sessionData); } await setDoc(dateDocRef, { sessions }); isModalOpen.value = false; cloudStatus.value = 'connected'; } catch (e) { cloudStatus.value = 'disconnected'; } };
                const startEditSession = (sess) => { formData.value = JSON.parse(JSON.stringify(sess)); editingSessionId.value = sess.id; viewMode.value = 'edit'; };
                const addNewSession = () => { formData.value = { id: Date.now().toString(), stakes: '30/10', location: '', rounds: '1', playerStats: {} }; editingSessionId.value = null; viewMode.value = 'edit'; if (!isModalOpen.value) isModalOpen.value = true; };

                // --- 6. 統計分析邏輯 ---
                const getHomePlayerStats = (name) => {
                    let games = 0, rounds = 0, wins = 0, winnings = 0, losses = 0; const cleanName = String(name).trim();
                    Object.entries(records.value).forEach(([date, rec]) => {
                        const [y, m] = date.split('-').map(Number);
                        if (y === currentYear.value && (monthFilter.value === 'all' || m === parseInt(monthFilter.value)) && rec.sessions) {
                            rec.sessions.forEach(sess => { if (sess.playerStats && sess.playerStats[cleanName] !== undefined) { games++; rounds += (Number(sess.rounds) || 0); const val = sess.playerStats[cleanName]; if (val > 0) { wins++; winnings += val; } else if (val < 0) { losses += val; } } });
                        }
                    });
                    return { games, rounds, winRate: games > 0 ? ((wins / games) * 100).toFixed(0) : 0, winnings, losses };
                };
                const getLocationStats = (name) => {
                    const stats = {}; const cleanName = String(name).trim();
                    Object.entries(records.value).forEach(([date, rec]) => { if (rec.sessions) { rec.sessions.forEach(sess => { if (sess.playerStats && sess.playerStats[cleanName] !== undefined) { const loc = sess.location?.trim() || '未標註'; if (!stats[loc]) stats[loc] = { total: 0, wins: 0 }; stats[loc].total++; if (sess.playerStats[cleanName] > 0) stats[loc].wins++; } }); } });
                    const result = {}; Object.entries(stats).forEach(([loc, s]) => { result[loc] = { total: s.total, winRate: ((s.wins / s.total) * 100).toFixed(0) }; });
                    return result;
                };
                const getPlayerHistory = (name) => {
                    const history = []; const cleanName = String(name).trim();
                    Object.entries(records.value).forEach(([date, rec]) => { if (rec.sessions) { rec.sessions.forEach(sess => { if (sess.playerStats && sess.playerStats[cleanName] !== undefined) { history.push({ date, amount: sess.playerStats[cleanName], location: sess.location || '未標註', stakes: sess.stakes, sessionId: sess.id, sessionData: sess }); } }); } });
                    return history.sort((a, b) => b.date.localeCompare(a.date));
                };

                const fetchData = () => {
                    if (!user.value) return;
                    onSnapshot(collection(db, 'artifacts', appId.value, 'public', 'data', 'records'), (snap) => {
                        const data = {};
                        snap.forEach(d => { 
                            const docData = d.data(); if (!docData.sessions && docData.playerStats) { docData.sessions = [{ ...docData, id: 'legacy-' + d.id }]; }
                            const normalizedId = normalizeDateString(d.id);
                            if (normalizedId === '2026-01-09') { // 1/9 校正
                                let changed = false;
                                const fixed = (docData.sessions || []).map(s => { if (s.location?.trim() === '阿如') { changed = true; return { ...s, location: '阿如家' }; } return s; });
                                if (changed) setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'records', d.id), { sessions: fixed });
                            }
                            data[normalizedId] = docData; 
                        });
                        records.value = data;
                    });
                    onSnapshot(doc(db, 'artifacts', appId.value, 'public', 'data', 'players_metadata', 'players_list'), (snap) => { if (snap.exists()) { players.value = snap.data().list.map(p => ({ ...p, category: ensureCategoryArray(p.category) })); } });
                };

                const downloadImage = () => { const el = document.querySelector('#app'); html2canvas(el, { backgroundColor: '#f7f6f6', ignoreElements: (e) => e.classList.contains('no-export') }).then(canvas => { const link = document.createElement('a'); link.download = `mahjong-record.png`; link.href = canvas.toDataURL(); link.click(); }); };

                // --- 7. 初始化 ---
                const firebaseApp = initializeApp(firebaseConfig);
                const auth = getAuth(firebaseApp);
                const db = getFirestore(firebaseApp);

                onMounted(async () => { lucide.createIcons(); await signInAnonymously(auth); onAuthStateChanged(auth, (u) => { user.value = u; if (u) { cloudStatus.value = 'connected'; fetchData(); } }); });
                watch([activeTab, isModalOpen, detailPlayer, isVerified, isMonthDetailOpen, leaderboardTab, isPlayerMgrOpen, isLocationMgrOpen], () => { setTimeout(() => lucide.createIcons(), 50); });

                return {
                    appId, activeTab, monthFilter, currentYear, currentMonth, records, players, leaderboardTab,
                    isVerified, isPlayerMgrOpen, isLocationMgrOpen, passwordInput, passwordError, categoryOptions, 
                    yearOptions: computed(() => { const base = new Date().getFullYear(); const list = []; for(let i = base - 5; i <= base + 5; i++) list.push(i); Object.keys(records.value).forEach(date => { const yr = parseInt(date.split('-')[0]); if(!list.includes(yr)) list.push(yr); }); return [...new Set(list)].sort((a,b) => a-b); }),
                    isModalOpen, viewMode, selectedDate, detailPlayer, cloudStatus, isMonthDetailOpen, showDeleteConfirm, editingSessionId, 
                    allHistoryLocations: computed(() => { const locs = new Set(); Object.values(records.value).forEach(r => { if (r.sessions) r.sessions.forEach(s => { if (s.location) locs.add(s.location.trim()); }); }); return Array.from(locs).sort(); }),
                    formData, newPlayerName, checkPassword, handleManualRefresh, handleQuickAdd, handleDateClick, togglePlayerInSession, toggleLocationInSession, handleAddNewPlayer, confirmDeleteSessFromList,
                    prevMonth: () => { if (currentMonth.value === 0) { currentMonth.value = 11; currentYear.value--; } else { currentMonth.value--; } }, 
                    nextMonth: () => { if (currentMonth.value === 11) { currentMonth.value = 0; currentYear.value++; } else { currentMonth.value++; } }, 
                    renameGlobalPlayer, deleteGlobalPlayer, renameLocationGlobalAll, deleteLocationGlobalAll, 
                    saveSession, deleteSession, startEditSession, addNewSession, downloadImage, formatDateKey, getDailyMergedScore, getPlayerCategories, getHomePlayerStats, 
                    updatePlayerCategory: async (name, catVal) => { const player = players.value.find(p => String(p.name).trim() === String(name).trim()); if (!player) return; let newCats = [...ensureCategoryArray(player.category)]; if (newCats.includes(catVal)) newCats = newCats.filter(c => c !== catVal); else newCats.push(catVal); if (newCats.length === 0) newCats = ['other']; const updatedList = players.value.map(p => p.name === player.name ? { ...p, category: newCats } : p); await setDoc(doc(db, 'artifacts', appId.value, 'public', 'data', 'players_metadata', 'players_list'), { list: updatedList }); }, 
                    getPlayerHistory, getLocationStats, getSortedPlayerStats,
                    displayLeaderboard: computed(() => { 
                        const map = {}; players.value.forEach(p => map[p.name] = { name: p.name, totalProfit: 0, winnings: 0, losses: 0, participateCount: 0, winCount: 0 }); 
                        Object.entries(records.value).forEach(([date, rec]) => { 
                            const [y, m] = date.split('-').map(Number);
                            if (y === currentYear.value && (monthFilter.value === 'all' || m === parseInt(monthFilter.value)) && rec.sessions) {
                                rec.sessions.forEach(sess => { Object.entries(sess.playerStats).forEach(([name, val]) => { const cleanName = String(name).trim(); if (!map[cleanName]) return; map[cleanName].totalProfit += val; map[cleanName].participateCount += 1; if (val > 0) { map[cleanName].winCount++; map[cleanName].winnings += val; } else if (val < 0) { map[cleanName].losses += val; } }); }); 
                            }
                        }); 
                        return Object.values(map).filter(s => s.participateCount > 0).filter(p => leaderboardTab.value === 'all' || getPlayerCategories(p.name).includes('family') || getPlayerCategories(p.name).includes('couple')).map(s => ({ ...s, totalWinnings: s.winnings, totalLosses: s.losses, winRate: ((s.winCount / s.participateCount) * 100).toFixed(1) })).sort((a, b) => b.totalProfit - a.totalProfit); 
                    }),
                    homeCardTitle: computed(() => { const mNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; return monthFilter.value === 'all' ? 'Yearly Balance' : `${mNames[parseInt(monthFilter.value)-1]} Balance`; }),
                    homeFilteredPlayers: computed(() => players.value.filter(p => { const cats = ensureCategoryArray(p.category); return cats.includes('family') || cats.includes('couple'); })),
                    stats: computed(() => { let familyProfit = 0, coupleProfit = 0; Object.entries(records.value).forEach(([date, rec]) => { const [y, m] = date.split('-').map(Number); if (y === currentYear.value && (monthFilter.value === 'all' || m === parseInt(monthFilter.value)) && rec.sessions) { rec.sessions.forEach(sess => { Object.entries(sess.playerStats).forEach(([name, amount]) => { const p = players.value.find(pl => String(pl.name).trim() === String(name).trim()); if (p) { const cats = ensureCategoryArray(p.category); if (cats.includes('family')) familyProfit += amount; if (cats.includes('couple')) coupleProfit += amount; } }); }); } }); return { familyProfit, coupleProfit }; }),
                    filteredMonthlyStats: computed(() => { const monthMap = {}; players.value.forEach(p => { monthMap[p.name] = { name: p.name, totalProfit: 0, participateCount: 0 }; }); Object.entries(records.value).forEach(([date, rec]) => { const [y, m] = date.split('-').map(Number); if (y === currentYear.value && m === (currentMonth.value + 1) && rec.sessions) { rec.sessions.forEach(sess => { Object.entries(sess.playerStats).forEach(([name, amount]) => { if (monthMap[name]) { monthMap[name].totalProfit += amount; monthMap[name].participateCount += 1; } }); }); } }); return Object.values(monthMap).filter(s => s.participateCount > 0).sort((a, b) => b.totalProfit - a.totalProfit); }),
                    currentMonthRecords: computed(() => { const filtered = {}; Object.entries(records.value).forEach(([date, rec]) => { const [y, m] = date.split('-').map(Number); if (y === currentYear.value && m === (currentMonth.value + 1)) { filtered[date] = rec; } }); return filtered; }),
                    getFilteredProfit: (name) => { let total = 0; const cleanName = String(name).trim(); Object.entries(records.value).forEach(([date, rec]) => { const [y, m] = date.split('-').map(Number); if (y === currentYear.value && (monthFilter.value === 'all' || m === parseInt(monthFilter.value)) && rec.sessions) { rec.sessions.forEach(sess => { if (sess.playerStats && sess.playerStats[cleanName] !== undefined) total += sess.playerStats[cleanName]; }); } }); return total; },
                    updateStat: (name, val) => { const isLoss = formData.value.playerStats[name] < 0; formData.value.playerStats[name] = isLoss ? -Math.abs(val) : Math.abs(val); },
                    toggleWinLoss: (name, type) => { const val = Math.abs(formData.value.playerStats[name] || 0); formData.value.playerStats[name] = type === 'win' ? val : -val; },
                    daysInMonth: computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate()), firstDayOfMonth: computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay()), cloudStatusText: computed(() => ({'connected':'雲端已同步', 'disconnected':'離線狀態', 'syncing':'正在同步...'}[cloudStatus.value]))
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
